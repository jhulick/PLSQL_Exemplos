------- Generated by SYS.DBMS_METADATA on 28-jan-2010 at 14:23:13 -------

  CREATE OR REPLACE PROCEDURE "RM"."GERA_RES_DEDUP" IS
-- Purpose: GENERATING THE DEDUPLICATION'S RESULTS FROM PPESSOA TABLE 
-- MODIFICATION HISTORY
-- Person      Date    Comments
-- ---------   ------  -------------------------------------------       
   CURSOR CDEDUP IS 
      SELECT * FROM DEDUPRES
      WHERE VOTE = 'V'
      ORDER BY CODA,CODB;  
      
   CURSOR CDEDUPESS(PCOD DEDUPESS.COD%TYPE) IS
      SELECT * FROM DEDUPESS
      WHERE COD = PCOD;       

   RDPES CDEDUPESS%ROWTYPE;
   IDG  DEDUPESS.GRUPO%TYPE := 0;
   IDGATUAL DEDUPESS.GRUPO%TYPE := 0;
   FLAGA INTEGER := 0;
   FLAGB INTEGER := 0;
   
BEGIN
   DBMS_OUTPUT.Put_Line('PROCESSO DE GERACAO DE RESULTADO DE DEDUPLICAO INICIALIZADO...');  
   DELETE FROM DEDUPESS;
   COMMIT;
   
   FOR X IN CDEDUP LOOP       
      FLAGA := 0;
      FLAGB := 0;
      
      OPEN CDEDUPESS(X.CODA);
      FETCH CDEDUPESS INTO RDPES;      
      IF(CDEDUPESS%FOUND ) THEN
         IDG := RDPES.GRUPO;
         FLAGA := 1; 
      END IF;
      CLOSE CDEDUPESS;
      RDPES := NULL;

      OPEN CDEDUPESS(X.CODB);
      FETCH CDEDUPESS INTO RDPES;
      IF(CDEDUPESS%FOUND) THEN
         IF(FLAGA = 0) THEN
            IDG := RDPES.GRUPO;
         END IF;
         FLAGB := 1;
      END IF;     
      CLOSE CDEDUPESS;     
      RDPES := NULL;

      IF(FLAGA=0 AND FLAGB=0) THEN
         IDGATUAL := IDGATUAL +1;
         IDG := IDGATUAL;           
         INSERT INTO DEDUPESS(COD,GRUPO) VALUES(X.CODA,IDG);
         INSERT INTO DEDUPESS(COD,GRUPO) VALUES(X.CODB,IDG);
      ELSIF(FLAGA=0) THEN
         INSERT INTO DEDUPESS(COD,GRUPO) VALUES(X.CODA,IDG);
      ELSIF(FLAGB=0) THEN
         INSERT INTO DEDUPESS(COD,GRUPO) VALUES(X.CODB,IDG);

      END IF;
      
      COMMIT;
   END LOOP;
   DBMS_OUTPUT.Put_Line('PROCESSO FIZALIZADO COM SUCESSO!!!');  
END; -- Procedure 
 
 
/
