DECLARE @CODCOLIGADA INTEGER 
DECLARE @IDMOV DATETIME 
DECLARE @CHAVEXML VARCHAR(44) 
DECLARE @CHAVE VARCHAR(44) 
DECLARE CURSOR_NOME CURSOR FOR 
  
      SELECT CODCOLIGADA, IDMOV, SUBSTRING(XMLNFE,(CHARINDEX('Id=', XMLNFE)+7),44) AS CHAVEXML, CHAVEACESSO 
            FROM TNFEESTADUAL 
BEGIN 
      OPEN CURSOR_NOME 
      FETCH NEXT FROM CURSOR_NOME INTO @CODCOLIGADA, @IDMOV, @CHAVEXML, @CHAVE 
      WHILE (@@FETCH_STATUS=0) 
      BEGIN 
            IF (@CHAVEXML <> @CHAVE) 
                UPDATE TNFEESTADUAL SET CHAVEACESSO = @CHAVEXML 
                   WHERE CODCOLIGADA = @CODCOLIGADA 
                             AND IDMOV = @IDMOV 
      FETCH NEXT FROM CURSOR_NOME INTO @CODCOLIGADA, @IDMOV, @CHAVEXML, @CHAVE 
      END 
      CLOSE CURSOR_NOME 
      DEALLOCATE CURSOR_NOME 
END

