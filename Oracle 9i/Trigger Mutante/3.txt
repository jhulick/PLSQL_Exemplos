-- Start of DDL Script for Trigger RM.PROIBE_DUPLICIDADE_FCFO_P2
-- Generated 13/10/2010 14:37:42 from RM@TESTENOVO

CREATE OR REPLACE TRIGGER proibe_duplicidade_fcfo_p2
 AFTER
  INSERT OR UPDATE
 ON fcfo
REFERENCING NEW AS NEW OLD AS OLD
DECLARE

QTD NUMBER;
RET VARCHAR(255);
CURSOR C_FCFO IS
  SELECT CODCFO
  FROM FCFO
  WHERE ATIVO=1
   AND CGCCFO=VARIAVEIS_RM.vCgcCfo
   AND CODCFO<>VARIAVEIS_RM.vCodCfo
  ORDER BY CODCFO;

BEGIN

IF VARIAVEIS_RM.vCgcCfo NOT IN ('C04994','F04861') THEN

 --INICIO: VALIDACAO GERAL
 IF VARIAVEIS_RM.vCgcCfo IS NULL THEN
     RAISE_APPLICATION_ERROR(-20000, 'ERRO: IMPOSSIVEL CADASTRAR, O CAMPO CPF/CNPJ E OBRIGATORIO - ASS: SUSIN, RAMAIS(3155,3289)',false);
 ELSE IF LENGTH (VARIAVEIS_RM.vCgcCfo) NOT IN (14,18) THEN
     RAISE_APPLICATION_ERROR(-20000, 'ERRO: IMPOSSIVEL CADASTRAR, MASCARA INVALIDA PARA O CAMPO CPF/CNPJ, INSIRA OS DIGITOS COM A MASCARA, VEJA EXEMPLO:. CPF: ###.###.###-## CNPJ: ##.###.###/####-##  - ASS: SUSIN, RAMAIS(3155,3289)',false);
 ELSE IF VARIAVEIS_RM.vNome IS NULL OR VARIAVEIS_RM.vNomeFantasia IS NULL THEN
     RAISE_APPLICATION_ERROR(-20000, 'ERRO: IMPOSSIVEL CADASTRAR, NOME OU NOME FANTASIA N?O PODE SER NULO - ASS: SUSIN, RAMAIS(3155,3289)',false);
 END IF; END IF; END IF;
 --FIM: VALIDACAO GERAL

 IF updating THEN
  IF VARIAVEIS_RM.vAtivo=1 THEN
    SELECT COUNT(*) INTO QTD FROM FCFO WHERE ATIVO=1 AND CGCCFO = VARIAVEIS_RM.vCgcCfo AND CODCFO <> VARIAVEIS_RM.vCodCfo;
    IF (QTD>0) THEN
      RET := '';
      FOR X IN C_FCFO LOOP
        RET := RET||X.CODCFO||',';
      END LOOP;
      RAISE_APPLICATION_ERROR(-20000, 'ERRO: Impossível cadastrar. Já existe um registro ATIVO com este CPF/CNPJ de código: '||RET||' ASS: SUSIN nos ramais(3155,3289)',false);
    END IF;
  END IF;
 END IF;

 IF inserting THEN
  IF VARIAVEIS_RM.vAtivo=1 THEN
    SELECT COUNT(*) INTO QTD FROM FCFO WHERE ATIVO=1 AND CGCCFO = VARIAVEIS_RM.vCgcCfo;
    IF (QTD>1) THEN
      RET := '';
      FOR X IN C_FCFO LOOP
        RET := RET||X.CODCFO||',';
      END LOOP;
      RAISE_APPLICATION_ERROR(-20000, 'ERRO: Impossível cadastrar. Já existe um registro ATIVO com este CPF/CNPJ de código: '||RET||' ASS: SUSIN nos ramais(3155,3289)',false);
    END IF;
  END IF;
 END IF;

END IF;

END;
/


-- End of DDL Script for Trigger RM.PROIBE_DUPLICIDADE_FCFO_P2
